<div class="container-fluid py-4">
    <h2 class="mb-4 text-center">
        {{ isEditMode ? 'Editar Canal' : 'Crear Nuevo Canal' }}
    </h2>

    <div class="col-md-12 mx-auto">
        <div class="card shadow-sm p-4">
            <form #channelForm="ngForm" (ngSubmit)="onSave()">

                <!-- Información Básica -->
                <div class="mb-4">
                    <h5 class="text-primary mb-3">Información Básica</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <mat-form-field appearance="outline" class="w-100">
                                <mat-label>Proveedor</mat-label>
                                <input matInput type="text" [(ngModel)]="channel.provider" name="provider" required
                                    placeholder="Ingrese el nombre del proveedor" />
                            </mat-form-field>
                        </div>
                        <div class="col-md-6 mb-3">
                            <mat-form-field appearance="outline" class="w-100">
                                <mat-label>GLN</mat-label>
                                <input matInput type="number" [(ngModel)]="channel.gln" name="gln"
                                    placeholder="Ingrese el GLN" [disabled]="disabledGln" />
                            </mat-form-field>
                        </div>
                    </div>
                </div>

                <!-- Configuración de Adaptación -->
                <div class="mb-4">
                    <h5 class="text-primary mb-3">Configuración de Adaptación</h5>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <mat-form-field appearance="outline" class="w-100">
                                <mat-label>Tipo de Adaptación</mat-label>
                                <select matNativeControl [(ngModel)]="channel.adaptation_type" name="adaptation_type"
                                    required>
                                    <option value="Redimensionar">Redimensionar</option>
                                    <option value="Remover_Fondo">Remover Fondo</option>
                                </select>
                            </mat-form-field>
                        </div>
                    </div>
                </div>

                <!-- Configuración de Imagen -->
                <div class="mb-4">
                    <h5 class="text-primary mb-3">Configuración de Imagen</h5>

                    <!-- Preview -->
                    <div class="d-flex align-items-start justify-content-center flex-wrap gap-4 mb-3">
                        <div class="dimension-preview" [ngStyle]="getPreviewStyle(channel)">
                            <span class="dimension-label-inside">
                                {{ channel.width || 0 }} x {{ channel.height || 0 }} {{ channel.extension || '' }}
                            </span>
                        </div>

                        <div class="col-md-8">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <mat-form-field appearance="outline" class="w-100">
                                        <mat-label>Width (Ancho)</mat-label>
                                        <input matInput type="number" [(ngModel)]="channel.width" name="width" required
                                            min="1" />
                                        <span matSuffix class="p-6">px</span>
                                    </mat-form-field>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <mat-form-field appearance="outline" class="w-100">
                                        <mat-label>Height (Alto)</mat-label>
                                        <input matInput type="number" [(ngModel)]="channel.height" name="height"
                                            required min="1" />
                                        <span matSuffix class="p-6">px</span>
                                    </mat-form-field>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <!-- <mat-form-field appearance="outline" class="w-100">
                                        <mat-label>Extensión</mat-label>
                                        <input
                                            matInput
                                            type="text"
                                            [(ngModel)]="channel.extension"
                                            name="extension"
                                            required
                                            placeholder="ej: jpg, png, webp"
                                        />
                                    </mat-form-field> -->
                                    <mat-form-field appearance="outline" class="w-100">
                                        <mat-label>Extensión</mat-label>
                                        <select matNativeControl [(ngModel)]="channel.extension" name="extension"
                                            required>
                                            <option value="jpg">jpg</option>
                                            <option value="png">png</option>
                                            <option value="webp">webp</option>
                                        </select>
                                    </mat-form-field>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <mat-form-field appearance="outline" class="w-100">
                                        <mat-label>Density (DPIs)</mat-label>
                                        <input matInput type="number" [(ngModel)]="channel.dpi" name="dpi" required
                                            min="1" />
                                    </mat-form-field>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <mat-form-field appearance="outline" class="w-100">
                                        <mat-label>Tamaño Máximo</mat-label>
                                        <input matInput type="number" [(ngModel)]="channel.max_size_kb"
                                            name="max_size_kb" placeholder="ej: 500, 1000" min="0" />
                                        <span matSuffix class="p-4">KB</span>
                                    </mat-form-field>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Color de Fondo</label>
                                    <fieldset class="fieldset-color-picker" [disabled]="channel.adaptation_type === 'Remover_Fondo'">
                                        <div class="color-picker-row">
                                            <button type="button" class="color-circle transparent-option"
                                                [ngClass]="{'selected': channel.background_color === 'transparent'}"
                                                matTooltip="Fondo transparente"
                                                (click)="channel.background_color = 'transparent'">
                                            </button>
                                            <button type="button" class="color-circle"
                                                [ngClass]="{'selected': channel.background_color === '#FFFFFF'}"
                                                [style.background]="'#FFFFFF'"
                                                (click)="channel.background_color = '#FFFFFF'"></button>
                                            <!-- <button type="button" class="color-circle" [ngClass]="{'selected': channel.background_color === '#F8F8FF'}" [style.background]="'#F8F8FF'" (click)="channel.background_color = '#F8F8FF'"></button> -->
                                            <button type="button" class="color-circle"
                                                [ngClass]="{'selected': channel.background_color === '#FFE4F0'}"
                                                [style.background]="'#FFE4F0'"
                                                (click)="channel.background_color = '#FFE4F0'"></button>
                                            <div class="custom-color-picker-wrapper d-flex align-items-center"
                                                style="gap:6px;">
                                                <label class="color-circle custom-picker position-relative"
                                                    [style.background]="isCustomColor(channel.background_color) ? channel.background_color : '#fff'">
                                                    <input #colorInput type="color" [value]="getCustomColorValue()"
                                                        (input)="setCustomColor($event)"
                                                        style="opacity:0;width:0;height:0;position:absolute;" />
                                                    <mat-icon *ngIf="!isCustomColor(channel.background_color)"
                                                        class="plus-icon"
                                                        style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:20px;color:#1976d2;pointer-events:none;">add</mat-icon>
                                                </label>
                                                <mat-icon class="custom-picker-icon"
                                                    style="font-size:20px;color:#555;cursor:pointer;"
                                                    (click)="$event.stopPropagation(); $event.preventDefault(); colorInput.click();">
                                                    <!-- Ícono invisible solo para mantener el área clickeable -->
                                                </mat-icon>
                                            </div>
                                        </div>
                                    </fieldset>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuracion de Renombrado -->
                <div class="mb-4">
                    <h5 class="text-primary mb-3">Configuracion de Renombrado de las Imagenes</h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <mat-form-field appearance="outline" class="w-100">
                                <mat-label>
                                    <span matTooltip="Estandar usa el GTIN/UPC a 14 digitos. Personalizado requiere cargar un archivo con codigos e identificadores." matTooltipPosition="above">
                                        Tipo de Renombrado*
                                    </span>
                                </mat-label>
                                <mat-select [(ngModel)]="channel.renaming_type" name="renaming_type" required (selectionChange)="onRenamingTypeChange($event.value)">
                                    <mat-option value="standard">Estándar</mat-option>
                                    <!-- <mat-option value="custom">Personalizado</mat-option> -->
                                </mat-select>
                            </mat-form-field>
                        </div>
                        <div class="col-md-6">
                            <mat-form-field appearance="outline" class="w-100">
                                <mat-label>
                                    <span matTooltip="Texto que se antepone al sufijo. Solo aplica cuando seleccionas renombrado personalizado." matTooltipPosition="above">
                                        Base del Renombrado*
                                    </span>
                                </mat-label>
                                <input matInput type="text" [(ngModel)]="channel.rename_base" name="rename_base" placeholder="ej: producto_, imagen_" [required]="channel.renaming_type === 'custom'" [disabled]="channel.renaming_type !== 'custom'" />
                            </mat-form-field>
                        </div>
                    </div>

                    <!-- <div class="custom-renaming-hint" *ngIf="channel.renaming_type === 'custom'">
                        <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2">
                            <span class="hint-badge text-white px-3 py-1 rounded-pill">Base para Renombrado Personalizado</span>
                            <span class="text-muted small">
                                Carga un archivo con la relacion de codigos y el identificador que deseas aplicar al renombrar las imagenes.
                            </span>
                        </div>
                    </div>
                    <div class="custom-renaming-actions" *ngIf="channel.renaming_type === 'custom'">
                        <button mat-raised-button color="primary" class="custom-renaming-action" type="button" (click)="fileInput.click()">
                            <mat-icon class="me-2">upload_file</mat-icon>
                            Cargar Archivo
                        </button>
                        <button mat-stroked-button color="primary" class="custom-renaming-action" type="button" (click)="downloadCustomTemplate()">
                            <mat-icon class="me-2">download</mat-icon>
                            Descargar Plantilla
                        </button>
                        <input #fileInput type="file" accept=".csv,.xlsx,.xls,.txt" class="d-none" (change)="onCustomFileSelected($event)" />
                        <div class="custom-renaming-file text-muted small" *ngIf="customRenameFileName">
                            Archivo seleccionado: <strong>{{ customRenameFileName }}</strong>
                        </div>
                    </div> -->

                    <div class="row g-3">
                        <div class="col-md-6">
                            <mat-form-field appearance="outline" class="w-100">
                                <mat-label>
                                    <span matTooltip="Caracter que separa la base del sufijo. Ejemplos: _, -, ." matTooltipPosition="above">
                                        Separador
                                    </span>
                                </mat-label>
                                <input matInput type="text" [(ngModel)]="channel.rename_separator" name="rename_separator" placeholder="ej: _, -, ." />
                            </mat-form-field>
                        </div>
                        <div class="col-md-6">
                            <mat-form-field appearance="outline" class="w-100">
                                <mat-label>
                                    <span matTooltip="Numero o letra con el que deseas iniciar la secuencia del sufijo." matTooltipPosition="above">
                                        Inicio secuencia de Sufijo
                                    </span>
                                </mat-label>
                                <input matInput type="number" [(ngModel)]="channel.rename_start_index" name="rename_start_index" min="0" />
                            </mat-form-field>
                        </div>
                    </div>
                </div>

                <!-- Configuración de Estructura -->
                <div class="mb-4">
                    <h5 class="text-primary mb-3">Configuración de Estructura</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <mat-form-field appearance="outline" class="w-100">
                                <mat-label>Estructura de Carpetas</mat-label>
                                <!-- <select matNativeControl [(ngModel)]="channel.folder_structure" name="folder_structure"
                                    required>
                                    <option value="Redimensionar">Redimensionar</option>
                                </select> -->
                                <mat-select [(ngModel)]="channel.folder_structure" name="folder_structure" required>
                                    <mat-option *ngFor="let structure of folderStructures" [value]="structure.id">
                                        {{ structure.name }}
                                    </mat-option>

                                </mat-select>

                            </mat-form-field>
                        </div>
                        <!-- </div>

                    <div class="row"> -->
                        <!-- <div class="col-sm-6 mb-3">
                            <mat-form-field appearance="outline" class="w-100">
                                <mat-label>Encarpetado</mat-label>
                                <mat-select [(ngModel)]="selectedFolderStructure">
                                    <mat-option *ngFor="let structure of folderStructures" [value]="structure.value">
                                        {{ structure.label }}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div> -->
                    </div>
                </div>

                <!-- Action buttons -->
                <div class="d-flex justify-content-end gap-2 mt-4" style="margin-right: 45px;">
                    <button type="button" mat-raised-button color="basic" (click)="onCancel()" [disabled]="isLoading">
                        Cancelar
                    </button>
                    <button type="submit" mat-raised-button color="primary"
                        [disabled]="!channelForm.valid || isLoading">
                        <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
                        {{ isEditMode ? 'Actualizar' : 'Crear' }} Canal
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
