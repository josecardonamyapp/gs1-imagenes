<div id="lista-procesamientos" class="job-status-container">
  <div class="header">
    <h2>Estado de Procesamiento de Imágenes</h2>
    <button id="actualizar-procesamientos" mat-raised-button color="primary" (click)="loadCompletedJobs()"
      [disabled]="loading">
      <mat-icon>refresh</mat-icon>
      Actualizar Todo
    </button>
  </div>

  <div class="jobs-grid" *ngIf="jobs.length > 0">

    <mat-card *ngFor="let job of jobs" class="job-card job-card--compact">
      <div class="job-groups">
        <!-- 1) Imagen -->
        <div class="group thumb" *ngIf="getThumb(job)">
          <img [src]="getThumb(job)!" [alt]="job.product_name || 'Producto'" />
        </div>

        <!-- 2) Nombre + GTIN -->
        <div class="group info">
          <div class="title" *ngIf="job.status != 'COMPLETED'" [matTooltip]="job.total_gtins + ' GTINs Procesandose…'">
            {{ job.total_gtins + ' GTINs Procesandose...' }}
          </div>
          <div class="title" *ngIf="job.status == 'COMPLETED'" [matTooltip]="job.total_gtins + ' GTINs Procesados'">
            {{ job.total_gtins > 1 ? job.total_gtins + ' GTINs Procesados' : job.total_gtins + ' GTIN Procesado' }}
          </div>
          <div class="gtin">GTIN: {{ job.total_gtins }} </div>
        </div>

        <!-- 3) Actualizado + Fecha -->
        <div class="group updated">
          <span class="label">Actualizado:</span>
          <span class="pill">{{ getUpdatedAt(job) | date:'M/d/yy, h:mm a' }}</span>
        </div>

        <!-- 4) Status + % -->
        <div class="group status">
          <span class="status-pill" [ngClass]="statusClass(job.status)">
            {{ job.status }}
          </span>
          <span class="pct" *ngIf="job.progress">{{ job.progress.progress_percentage || 0 }}%</span>
        </div>

        <!-- 5) Acciones -->
        <div *ngIf="['COMPLETED', 'COMPLETED_WITH_ERRORS'].includes(job.status)" class="group actions">
          <mat-form-field appearance="outline" class="actions-select">
            <mat-select placeholder="Acciones" [(value)]="job.selectedAction" (selectionChange)="handleAction($event.value, job)">
              <mat-option value="refresh" [disabled]="job.status === 'LOADING'">Actualizar</mat-option>
              <mat-option value="download"
                [disabled]="(job.status !== 'COMPLETED' && !  job.processed_files.length) || job.downloading || !(job.processed_files?.length)">
                {{ job.downloading ? 'Descargando...' : 'Descargar Todos' }}
              </mat-option>
              <mat-option value="link" [disabled]="job.status === 'PROCESSING' || job.generatingLink">
                {{ job.generatingLink ? 'Generando link...' : 'Generar link' }}
              </mat-option>
              <mat-option value="errors" *ngIf="job.errors?.length || job.error_summary?.total_errors">
                Ver detalle de errores
              </mat-option>
              <!-- <mat-option value="regenerate">Regenerar</mat-option> -->
              <mat-option value="delete" [disabled]="job.status === 'PROCESSING'">Eliminar</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <!-- Progreso (opcional) ocupa grupos 2–4 -->
        <!-- <div class="group progress" *ngIf="job.progress">
      <mat-progress-bar mode="determinate"
                        [value]="job.progress.progress_percentage || 0"
                        class="bar-xs"></mat-progress-bar>
    </div> -->
      </div>
      <!-- Overlay por tarjeta cuando hay acciones en curso -->
      <div class="job-card-overlay" *ngIf="job.downloading || job.generatingLink">
        <mat-spinner diameter="36"></mat-spinner>
        <p class="overlay-text">
          {{ job.downloading ? 'Descargando...' : 'Generando link...' }}
        </p>
      </div>
    </mat-card>
  </div>

  <div class="jobs-grid" *ngIf="completedJobs.length > 0">

    <mat-card *ngFor="let job of completedJobs" class="job-card job-card--compact">
      <div class="job-groups">
        <!-- 1) Imagen -->
        <div class="group thumb" *ngIf="getThumb(job)">
          <img [src]="getThumb(job)!" [alt]="job.product_name || 'Producto'" />
        </div>

        <!-- 2) Nombre + GTIN -->
        <div class="group info">
          <div class="title" *ngIf="job.status != 'COMPLETED'" [matTooltip]="job.total_gtins + ' GTINs Procesandose…'">
            {{ job.total_gtins + ' GTINs Procesandose...' }}
          </div>
          <div class="title" *ngIf="job.status == 'COMPLETED'" [matTooltip]="job.total_gtins + ' GTINs Procesados'">
            {{ job.total_gtins > 1 ? job.total_gtins + ' GTINs Procesados' : job.total_gtins + ' GTIN Procesado' }}
          </div>
          <div class="gtin">GTIN: {{ job.total_gtins }} </div>
        </div>

        <!-- 3) Actualizado + Fecha -->
        <div class="group updated">
          <span class="label">Actualizado:</span>
          <span class="pill">{{ getUpdatedAt(job) | date:'M/d/yy, h:mm a' }}</span>
        </div>

        <!-- 4) Status + % -->
        <div class="group status">
          <span class="status-pill" [ngClass]="statusClass(job.status)">
            {{ job.status }}
          </span>
          <span class="pct" *ngIf="job.progress">{{ job.progress.progress_percentage || 0 }}%</span>
        </div>

        <!-- 5) Acciones -->
        <div *ngIf="['COMPLETED', 'COMPLETED_WITH_ERRORS'].includes(job.status)" class="group actions">
          <mat-form-field appearance="outline" class="actions-select">
            <mat-select placeholder="Acciones" [(value)]="job.selectedAction" (selectionChange)="handleAction($event.value, job)">
              <mat-option value="refresh" [disabled]="job.status === 'LOADING'">Actualizar</mat-option>
              <mat-option value="download"
                [disabled]="(job.status !== 'COMPLETED' && !  job.processed_files.length) || job.downloading || !(job.processed_files?.length)">
                {{ job.downloading ? 'Descargando...' : 'Descargar Todos' }}
              </mat-option>
              <mat-option value="link" [disabled]="job.status === 'PROCESSING' || job.generatingLink">
                {{ job.generatingLink ? 'Generando link...' : 'Generar link' }}
              </mat-option>
              <mat-option value="errors" *ngIf="job.errors?.length || job.error_summary?.total_errors">
                Ver detalle de errores
              </mat-option>
              <!-- <mat-option value="regenerate">Regenerar</mat-option> -->
              <mat-option value="delete" [disabled]="job.status === 'PROCESSING'">Eliminar</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <!-- Progreso (opcional) ocupa grupos 2–4 -->
        <!-- <div class="group progress" *ngIf="job.progress">
      <mat-progress-bar mode="determinate"
                        [value]="job.progress.progress_percentage || 0"
                        class="bar-xs"></mat-progress-bar>
    </div> -->
      </div>

      <!-- Overlay por tarjeta cuando hay acciones en curso -->
      <div class="job-card-overlay" *ngIf="job.downloading || job.generatingLink">
        <mat-spinner diameter="36"></mat-spinner>
        <p class="overlay-text">
          {{ job.downloading ? 'Descargando...' : 'Generando link...' }}
        </p>
      </div>
    </mat-card>


  </div>

  <!-- Estado vacío -->
  <div class="empty-state" *ngIf="completedJobs.length === 0">
    <div class="empty-icon">
      <mat-icon>work_off</mat-icon>
    </div>
    <h3>No hay trabajos de procesamiento</h3>
    <p>Los trabajos de transformación de imágenes aparecerán aquí cuando proceses productos.</p>
    <button id="procesar-productos" mat-raised-button color="primary" routerLink="/dashboards/dashboard1">
      <mat-icon>add</mat-icon>
      Procesar Productos
    </button>
  </div>

  <!-- Indicador de carga -->
  <div class="loading-overlay" *ngIf="loading">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Consultando estado de trabajos...</p>
  </div>
</div>
