import { Component, AfterViewInit, ElementRef, HostListener, OnInit, ViewChild } from '@angular/core';
import { TablerIconsModule } from 'angular-tabler-icons';
import { ProductService, SyncfoniaProduct } from 'src/app/services/product.service';
import { MatIconModule } from '@angular/material/icon';
import { CommonModule } from '@angular/common';
import { Router } from '@angular/router';
import { MaterialModule } from 'src/app/material.module';
import { FormsModule } from '@angular/forms';
import { MatFormFieldModule } from '@angular/material/form-field';
import { MatInputModule } from '@angular/material/input';
import { MatButtonModule } from '@angular/material/button';
import { MatProgressSpinnerModule } from '@angular/material/progress-spinner';
import { MatCheckboxModule, MatCheckboxChange } from '@angular/material/checkbox';
import { MatSnackBar, MatSnackBarModule } from '@angular/material/snack-bar';
import { CatalogProduct } from 'src/app/model/catalog';
import { CreateCatalogDialogComponent, CreateCatalogDialogData } from './create-catalog-dialog/create-catalog-dialog.component';
import { Subject, firstValueFrom } from 'rxjs';
import { debounceTime, distinctUntilChanged } from 'rxjs/operators';
import { TourModule } from 'src/app/core/tour/tour.module';
import { DriverTourService } from 'src/app/core/tour/driver-tour.service';

import { CatalogService } from 'src/app/services/catalog.service';

const createProductKey = (gtin: string, gln?: string | null): string => `${gtin || ''}::${gln || ''}`;

@Component({
  selector: 'app-dashboard1',
  standalone: true,
  imports: [
    TablerIconsModule,
    MatIconModule,
    CommonModule,
    MaterialModule,
    FormsModule,
    MatFormFieldModule,
    MatInputModule,
    MatButtonModule,
    MatProgressSpinnerModule,
    MatCheckboxModule,
    MatSnackBarModule,
    TourModule,
    CreateCatalogDialogComponent
  ],
  templateUrl: './dashboard1.component.html',
  styleUrl: './dashboard1.component.scss'
})
export class AppDashboard1Component implements OnInit, AfterViewInit {
  products: any[] = [];
  carouselImages: any[] = [];
  selectedProduct: any = null;
  currentIndex = 0;
  searchText: string = '';
  gtinListInput: string = '';
  isGenerating = false;
  selectedGtins: string[] = [];
  filtered: any[] = [];
  searchSubject: Subject<string> = new Subject<string>();
  inputType: 'text' | 'number' | 'mixed' | null = null;
  catalogPanelVisible = false;
  catalogList: any[] = [];
  catalogPanelData: CreateCatalogDialogData | null = null;
  catalogSelected: any = null;
  showToolbar = true;

  @ViewChild('toolbar') toolbarRef?: ElementRef<HTMLDivElement>;
  @ViewChild('toolbarToggle', { static: true }) toolbarToggleRef?: ElementRef<HTMLButtonElement>;
  tourByRoute: Record<string, any[]> = {
    '/dashboards/dashboard1': [
      {
        element: '#menu-inicio',
        popover: {
          title: 'Inicio',
          description: 'Accede al panel principal para comenzar a gestionar tus productos y actividades.'
        }
      },
      {
        element: '#input-gtin',
        popover: {
          title: 'Buscar productos',
          description: 'Ingresa el nombre del producto o su código GTIN para realizar una búsqueda directa.',
        },
        allowInteraction: true
      },
      {
        element: '#btn-seleccionar-todos',
        popover: {
          title: 'Seleccionar todos los productos',
          description: 'Haz clic aquí para seleccionar rápidamente todos los productos mostrados.',
        }
      },
      {
        element: '#btn-buscar-gtins',
        popover: {
          title: 'Búsqueda por lista de GTINs',
          description: 'Importa una lista con múltiples GTINs para realizar una búsqueda masiva.',
        }
      },
      {
        element: '#tarjeta-producto-1',
        popover: {
          title: 'Vista de producto',
          description: 'Cada tarjeta muestra información clave de un producto individual.',
        }
      },
      {
        element: '#carousel-imagenes',
        popover: {
          title: 'Carrusel de imágenes',
          description: 'Desplázate entre las imágenes disponibles del producto para visualizar sus distintas vistas.',
        }
      },
      {
        element: '#informacion-tarjeta',
        popover: {
          title: 'Detalles del producto',
          description: 'Consulta aquí detalles adicionales como imágenes, descripciones y opciones de procesamiento.',
        }
      }
    ]
  };

  constructor(
    private productService: ProductService,
    private router: Router,
    private snackBar: MatSnackBar,
    private tourService: DriverTourService,
    private catalogService: CatalogService
  ) { }
          })
          .filter((product): product is any => product !== null);

        const productsByKey = new Map(
          this.products.map(product => [createProductKey(product.gtin, product.gln), product])
        );
        fetchedProducts.forEach((product: any) => {
          productsByKey.set(createProductKey(product.gtin, product.gln), product);
        });

        this.products = Array.from(productsByKey.values()).map(product => this.prepareProductForDisplay(product));
        console.log('products', this.products)

        const requestedOrder = Array.isArray(requestedCodes) && requestedCodes.length > 0
          ? requestedCodes
          : gtins;

        const productsByGtin = new Map<string, any[]>();
        this.products.forEach(product => {
          const list = productsByGtin.get(product.gtin) ?? [];
          list.push(product);
          productsByGtin.set(product.gtin, list);
        });

        this.filtered = [];
        requestedOrder.forEach(code => {
          const list = productsByGtin.get(code);
          if (Array.isArray(list) && list.length > 0) {
            list.forEach(product => {
              this.filtered.push(this.prepareProductForDisplay(product));
            });
          }
        });

        if (!requestedOrder.length) {
          this.filtered = this.products.map(product => this.prepareProductForDisplay(product));
        }
        this.autoToggleToolbarOnResults();

        if (fetchedProducts.length !== normalizedProducts.length) {
          this.snackBar.open('Varios GTINs fueron omitidos durante la carga, ya que no disponen de imágenes asociadas en Syncfonía.', 'Cerrar', {
            duration: 3000,
            verticalPosition: 'top',
            horizontalPosition: 'center'
          });
        }
      } else {
        this.snackBar.open('No se encontraron GTINs relacionados al GLN', 'Cerrar', {
          duration: 3000,
          verticalPosition: 'top',
          horizontalPosition: 'center'
        });
      }
    } catch (err: any) {
      this.snackBar.open(err?.error || 'Error al obtener productos por GTINs.', 'Cerrar', {
        duration: 3000,
        verticalPosition: 'top',
        horizontalPosition: 'center'
      });
      console.error('Error al obtener productos por GTINs:', err);
    } finally {
      this.isGenerating = false;
    }
    // });
  }

  nextImage(product: any): void {
    if (!product?.images?.length || product.images.length <= 1) {
      return;
    }

    const nextIndex =
      product.currentIndex === product.images.length - 1
        ? 0
        : product.currentIndex + 1;

    this.updateProductImageIndex(product, nextIndex);
  }

  previousImage(product: any): void {
    if (!product?.images?.length || product.images.length <= 1) {
      return;
    }

    const previousIndex =
      product.currentIndex === 0
        ? product.images.length - 1
        : product.currentIndex - 1;

    this.updateProductImageIndex(product, previousIndex);
  }

  private updateProductImageIndex(product: any, targetIndex: number): void {
    if (!product?.images?.length) {
      return;
    }

    const totalImages = product.images.length;
    const normalizedIndex = ((Number.isInteger(targetIndex) ? targetIndex : 0) % totalImages + totalImages) % totalImages;

    if (normalizedIndex === product.currentIndex) {
      return;
    }

    const nextImage = product.images[normalizedIndex];
    const hasUrl = Boolean(nextImage?.uniformresourceidentifier);

    product.isImageLoading = hasUrl;
    product.currentIndex = normalizedIndex;

    if (!hasUrl) {
      product.isImageLoading = false;
    }
  }

  goToDetail(gtin: string): void {
    this.router.navigate(['/product', gtin]);
  }

  onSearchChange(value: string | null | undefined) {
    const trimmed = (value ?? '').trim();

    if (!trimmed) {
      this.inputType = null;
      this.filtered = [];
      this.searchText = '';          // â† refleja en el textarea
      this.searchSubject.next('');
      this.autoToggleToolbarOnResults();
      return;
    }

    // Detectar tipo admitiendo comas, espacios y saltos de lÃ­nea
    if (/^[0-9,\s`r`n]+$/.test(trimmed)) {
      this.inputType = 'number';
    } else if (/^[a-zA-ZÃ¡Ã©Ã­Ã³ÃºÃÃ‰ÃÃ“ÃšÃ±Ã‘\s]+$/.test(trimmed)) {
      this.inputType = 'text';
    } else {
      this.inputType = 'mixed';
    }

    let normalized = trimmed;

    if (this.inputType === 'number') {
      normalized = normalized
        .replace(/[\s`r`n]+/g, ',') // saltos de lÃ­nea/espacios â†’ coma
        .replace(/,{2,}/g, ',')     // evita ,, consecutivas
        .replace(/^,|,$/g, '');     // sin coma al inicio/fin

      // Autocompletar a 14 dÃ­gitos
      const paddedCodes = normalized
        .split(',')
        .map(code => code.trim())
        .filter(code => Boolean(code))
        .map(code => code.padStart(14, '0'));

      normalized = Array.from(new Set(paddedCodes)).join(',');
    } else if (this.inputType === 'text') {
      normalized = normalized.replace(/\s+/g, ' ');
    }

    // ðŸ” Reflejar el valor normalizado en el textarea y continuar flujo
    this.searchText = normalized;       // â† actualiza el textarea
    this.searchSubject.next(normalized);

    console.log('inputType:', this.inputType, '=>', normalized);
  }


  private async handleSearch(value: string) {
    console.log('handlesearch', value);
    if (!value) {
      this.filtered = [];
      this.autoToggleToolbarOnResults();
      this.refreshCatalogPanelData();
      return;
    }

    if (this.inputType == 'text') {
      const localMatches = this.products.filter(p =>
        p.producName?.toLowerCase().includes(value.toLowerCase())
      );

      this.filtered = localMatches.map(product => this.prepareProductForDisplay(product));
      this.autoToggleToolbarOnResults();
    } else if (this.inputType == 'number') {
      const codes = value.split(',').map(code => code.trim()).filter(Boolean);
      console.log('codes', codes);

      const localMatches = this.products.filter(p => codes.includes(p.gtin));
      const missingCodes = codes.filter(code => !localMatches.some(p => p.gtin === code));

      this.filtered = localMatches.map(product => this.prepareProductForDisplay(product));
      this.autoToggleToolbarOnResults();

      if (missingCodes.length > 0) {
        console.log('missingCodes', missingCodes);
        await this.getProductsByListGtin(missingCodes, codes);
      }
    } else {
      this.applyFilter();
    }

    this.refreshCatalogPanelData();
    console.log('filtered', this.filtered);
  }

  clearSearch() {
    this.searchText = '';
    this.inputType = null;
    this.filtered = [];
    this.searchSubject.next('');
    this.autoToggleToolbarOnResults();
    this.refreshCatalogPanelData();
  }

  applyFilter() {
    const query = this.searchText.toLowerCase();
    this.filtered = this.products.filter(p =>
      p.producName?.toLowerCase().includes(query) ||
      p.gtin?.toLowerCase().includes(query)
    );
    this.autoToggleToolbarOnResults();

    this.refreshCatalogPanelData();
  }

  trackByGtin(index: number, item: any): string {
    return createProductKey(item.gtin, item.gln);
  }

  // filteredProducts() {
  //   if (!this.searchText) return this.products;

  //   const query = this.searchText.toLowerCase();

  //   return this.products.filter(p =>
  //     p.producName?.toLowerCase().includes(query) ||
  //     p.gtin?.toLowerCase().includes(query)
  //   );
  // }


  toggleGtinSelection(gtin: string): void {
    const index = this.selectedGtins.indexOf(gtin);

    if (index > -1) {
      this.selectedGtins.splice(index, 1);
    } else {
      this.selectedGtins.push(gtin);
    }

    this.refreshCatalogPanelData();
  }

  onProductSelectionChange(event: MatCheckboxChange, gtin: string): void {
    if (event.checked) {
      if (!this.isGtinSelected(gtin)) {
        this.selectedGtins.push(gtin);
      }
    } else if (this.isGtinSelected(gtin)) {
      this.selectedGtins = this.selectedGtins.filter(selected => selected !== gtin);
    }

    this.refreshCatalogPanelData();
  }

  isGtinSelected(gtin: string): boolean {
    return this.selectedGtins.includes(gtin);
  }

  selectAllGtins(): void {
    this.selectedGtins = this.filtered
      .filter(p => p.images?.length > 0)
      .map(p => p.gtin);

    this.refreshCatalogPanelData();
  }

  clearAllGtins(): void {
    this.selectedGtins = [];
    this.refreshCatalogPanelData();
  }

  openCreateCatalogDialog(): void {
    this.catalogPanelVisible = true;
    this.refreshCatalogPanelData();
  }

  private refreshCatalogPanelData(): void {
    if (!this.catalogPanelVisible) {
      return;
    }

    const sourceProducts = this.filtered.length ? this.filtered : this.products;
    this.catalogPanelData = {
      availableProducts: this.buildCatalogProducts(sourceProducts),
      preselectedGtins: [...this.selectedGtins]
    };
  }

  private buildCatalogProducts(products: any[]): CatalogProduct[] {
    const mapped: CatalogProduct[] = [];
    const seen = new Set<string>();

    (products || []).forEach(product => {
      const gtin = product?.gtin;
      if (!gtin || seen.has(gtin)) {
        return;
      }

      seen.add(gtin);
      mapped.push({
        gtin,
        name: product?.producName ?? product?.name ?? '',
        producName: product?.producName ?? product?.name ?? '',
        imageUrl: product?.images?.[0]?.uniformresourceidentifier,
        images: product?.images ?? [],
        currentIndex: product?.currentIndex ?? 0,
        isImageLoading: false
      });
    });

    return mapped;
  }

  handleCatalogSaved(_event: unknown): void {
    this.clearAllGtins();
    this.catalogPanelVisible = false;
    this.catalogPanelData = null;
  }

  onCatalogPanelCancel(): void {
    this.catalogPanelVisible = false;
    this.catalogPanelData = null;
  }

  onCatalogSelectionChange(gtins: string[]): void {
    this.selectedGtins = [...gtins];
    this.refreshCatalogPanelData();
  }


  onProductImageLoad(product: any): void {
    if (product) {
      product.isImageLoading = false;
    }
  }

  onProductImageError(product: any): void {
    if (product) {
      product.isImageLoading = false;
    }
  }

  onCatalogSelectedChange(catalogId: string): void {
    const catalogData = this.catalogList.find(c => c.catalog_id === catalogId) || null;
    this.filtered = catalogData && catalogData.data ? catalogData.data : [];
    this.autoToggleToolbarOnResults();
  }

  private prepareProductForDisplay(product: any): any {
    if (!product) {
      return product;
    }

    if (!Array.isArray(product.images)) {
      product.images = [];
    }

    if (typeof product.currentIndex !== 'number') {
      product.currentIndex = 0;
    }

    if (product.images.length === 0) {
      product.currentIndex = 0;
    } else if (product.currentIndex < 0 || product.currentIndex >= product.images.length) {
      product.currentIndex = 0;
    }

    if (typeof product.isImageLoading !== 'boolean') {
      product.isImageLoading = false;
    } else if (product.isImageLoading && product.images.length <= 1) {
      product.isImageLoading = false;
    }

    return product;
  }

  loadCodesFromTextarea(): void {
    const normalized = (this.searchText || '').trim();
    if (!normalized) {
      this.snackBar.open('Pega al menos un codigo UPC o GTIN para continuar.', 'Cerrar', {
        duration: 3000,
        verticalPosition: 'top',
        horizontalPosition: 'center'
      });
      return;
    }

    this.onSearchChange(normalized);
    this.snackBar.open('Lista de codigos lista para buscar.', 'Cerrar', {
      duration: 2000,
      verticalPosition: 'bottom',
      horizontalPosition: 'center'
    });
  }

  downloadTemplate(): void {
    if (typeof window === 'undefined' || typeof document === 'undefined') {
      return;
    }

    const exampleContent = '7506228087658\n7506253223237\n75062652322306';
    const blob = new Blob([exampleContent], { type: 'text/plain;charset=utf-8' });
    const url = window.URL.createObjectURL(blob);
    const anchor = document.createElement('a');
    anchor.href = url;
    anchor.download = 'plantilla-upc.txt';
    anchor.rel = 'noopener';
    anchor.click();
    window.URL.revokeObjectURL(url);
  }

  processSelectedImages() {
    this.router.navigate(['/product-catalog'], {
      queryParams: { gtin: this.selectedGtins }
    });
    console.log('procesar', this.selectedGtins)
  }

  private autoToggleToolbarOnResults(): void {
    this.showToolbar = this.filtered.length === 0;
  }

  toggleToolbar(event: MouseEvent): void {
    event.stopPropagation();
    this.showToolbar = !this.showToolbar;
  }

  @HostListener('document:click', ['$event'])
  startDashboardTour(force = false): void {
    const steps = this.tourByRoute['/dashboards/dashboard1'];
    if (!steps || steps.length === 0) {
      return;
    }

    const userId = localStorage.getItem('user_id') || 'dashboard_user';
    const tourKey = 'dashboard1';

    if (force) {
      this.tourService.forceStartTour(steps);
      return;
    }

    this.tourService.startTourIfFirstTime(userId, tourKey, steps);
  }
  handleDocumentClick(event: Event): void {
    if (!this.showToolbar || !this.toolbarRef?.nativeElement) {
      return;
    }

    const target = event.target as HTMLElement | null;
    const toolbarEl = this.toolbarRef?.nativeElement ?? null;
    const toggleEl = this.toolbarToggleRef?.nativeElement ?? null;

    if ((toolbarEl && toolbarEl.contains(target)) || (toggleEl && toggleEl.contains(target))) {
      return;
    }

    if (this.filtered.length === 0) {
      return;
    }

    this.showToolbar = false;
  }

}







